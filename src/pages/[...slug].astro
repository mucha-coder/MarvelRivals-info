---
// 日本語記事詳細ページ
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { useTranslations } from '../i18n/ui';

// 静的パス生成
export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ id }) => id.startsWith('ja/'));
  
  return posts.map((post) => {
    const slug = post.slug.replace(/^ja\//, '');
    return {
      params: { slug },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { Content } = await post.render();
const t = useTranslations('ja');

// 対応する英語記事があるか確認
const allPosts = await getCollection('posts');
const enSlug = post.slug.replace(/^ja\//, '');
const hasEnglishVersion = allPosts.some((p) => p.slug === `en/${enSlug}`);

// 日付フォーマット
const dateFormatter = new Intl.DateTimeFormat('ja-JP', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// カテゴリ
const categoryColors: Record<string, string> = {
  'patch-notes': 'bg-yellow-400 text-black',
  'hero-balance': 'bg-purple-500 text-white',
  'events': 'bg-blue-500 text-white',
  'guides': 'bg-green-500 text-white',
};
const categoryColor = categoryColors[post.data.category] || 'bg-gray-500 text-white';
const categoryKey = `category.${post.data.category}` as keyof ReturnType<typeof useTranslations>;
const categoryLabel = t(categoryKey);
---

<BaseLayout 
  title={post.data.title} 
  description={post.data.description} 
  lang="ja"
  heroImage={post.data.heroImage}
>
  <article class="mx-auto max-w-4xl px-4 sm:px-6 py-8 sm:py-12">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-gray-400">
      <a href="/" class="hover:text-yellow-400 transition-colors">ホーム</a>
      <span class="mx-2 text-gray-600">›</span>
      <span class="text-gray-300">{categoryLabel}</span>
    </nav>

    <!-- Article Header -->
    <header class="mb-8">
      <!-- Category Badge -->
      <span class:list={['inline-block px-3 py-1 rounded text-xs font-bold uppercase tracking-wide mb-4', categoryColor]}>
        {categoryLabel}
      </span>
      
      <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-4 leading-tight">
        {post.data.title}
      </h1>
      
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-400">
        <time datetime={post.data.pubDate.toISOString()}>
          {dateFormatter.format(post.data.pubDate)}
        </time>
        
        {post.data.updatedDate && (
          <span class="text-yellow-400">
            （更新: {dateFormatter.format(post.data.updatedDate)}）
          </span>
        )}
      </div>
      
      <!-- Related Heroes -->
      {post.data.heroes && post.data.heroes.length > 0 && (
        <div class="mt-4 flex flex-wrap gap-2">
          {post.data.heroes.map((hero) => {
            const heroKey = `hero.${hero}` as any;
            const heroName = t(heroKey) || hero;
            return (
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-white/10 text-gray-300">
                {heroName}
              </span>
            );
          })}
        </div>
      )}
      
      <!-- English Version Link -->
      {hasEnglishVersion && (
        <div class="mt-4">
          <a
            href={`/en/${enSlug}`}
            class="inline-flex items-center gap-2 text-sm text-yellow-400 hover:text-yellow-300 transition-colors"
          >
            <span>→ Read in English</span>
          </a>
        </div>
      )}
    </header>
    
    <!-- Hero Image -->
    {post.data.heroImage && (
      <div class="mb-8 rounded-xl overflow-hidden">
        <img
          src={post.data.heroImage}
          alt=""
          class="w-full h-auto"
        />
      </div>
    )}
    
    <!-- Article Content -->
    <div class="prose prose-lg prose-invert max-w-none">
      <Content />
    </div>
    
    <!-- Back to Home -->
    <footer class="mt-12 pt-8 border-t border-white/10">
      <a
        href="/"
        class="inline-flex items-center text-sm text-gray-400 hover:text-yellow-400 transition-colors"
      >
        ← 記事一覧に戻る
      </a>
    </footer>
  </article>
</BaseLayout>

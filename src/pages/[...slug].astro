---
// 日本語記事詳細ページ
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { useTranslations } from '../i18n/ui';

// 静的パス生成
export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ id }) => id.startsWith('ja/'));
  
  return posts.map((post) => {
    const slug = post.slug.replace(/^ja\//, '');
    return {
      params: { slug },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { Content } = await post.render();
const t = useTranslations('ja');

// 対応する英語記事があるか確認
const allPosts = await getCollection('posts');
const enSlug = post.slug.replace(/^ja\//, '');
const hasEnglishVersion = allPosts.some((p) => p.slug === `en/${enSlug}`);

// 日付フォーマット
const dateFormatter = new Intl.DateTimeFormat('ja-JP', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// カテゴリ名
const categoryKey = `category.${post.data.category}` as keyof ReturnType<typeof useTranslations>;
const categoryLabel = t(categoryKey);
---

<BaseLayout 
  title={post.data.title} 
  description={post.data.description} 
  lang="ja"
  heroImage={post.data.heroImage}
>
  <article class="mx-auto max-w-3xl px-4 sm:px-6 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-gray-500">
      <a href="/" class="hover:text-blue-600">ホーム</a>
      <span class="mx-2">›</span>
      <span>{categoryLabel}</span>
    </nav>

    <!-- Article Header -->
    <header class="mb-8 pb-6 border-b border-gray-200">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4 leading-tight">
        {post.data.title}
      </h1>
      
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
        <time datetime={post.data.pubDate.toISOString()}>
          {dateFormatter.format(post.data.pubDate)}
        </time>
        
        {post.data.updatedDate && (
          <span class="text-blue-600">
            （更新: {dateFormatter.format(post.data.updatedDate)}）
          </span>
        )}
      </div>
      
      <!-- Related Heroes -->
      {post.data.heroes && post.data.heroes.length > 0 && (
        <div class="mt-4 flex flex-wrap gap-2">
          {post.data.heroes.map((hero) => (
            <span class="inline-flex items-center px-2 py-1 rounded text-sm bg-gray-100 text-gray-700">
              {hero}
            </span>
          ))}
        </div>
      )}
      
      <!-- English Version Link -->
      {hasEnglishVersion && (
        <div class="mt-4">
          <a
            href={`/en/${enSlug}`}
            class="text-sm text-blue-600 hover:underline"
          >
            → Read in English
          </a>
        </div>
      )}
    </header>
    
    <!-- Article Content -->
    <div class="prose prose-gray max-w-none">
      <Content />
    </div>
    
    <!-- Back to Home -->
    <footer class="mt-12 pt-6 border-t border-gray-200">
      <a
        href="/"
        class="text-sm text-gray-500 hover:text-blue-600"
      >
        ← 記事一覧に戻る
      </a>
    </footer>
  </article>
</BaseLayout>
